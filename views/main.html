<!DOCTYPE html>
<html manifest="main.manifest">
<head>
	<title>FillCartForMe - <%= title %></title>
	<meta name="viewport" content="width=device-width,initial-scale=1"/>
	<link rel="stylesheet" href="/stylesheets/bootstrap.min.css"  type="text/css">
	<link href="/stylesheets/style.css"  rel="stylesheet" type="text/css"/>
	<link href="/stylesheets/jquerytagsinput.css"  rel="stylesheet" type="text/css"/>
    <script src="/nowjs/now.js" type="text/javascript"></script>
	<script src="/javascripts/jquery.min.js" type="text/javascript"></script>
	<script src="/javascripts/bootstrap-buttons.js" type="text/javascript"></script>
	<script src="/javascripts/bootstrap-alerts.js" type="text/javascript"></script>
	<script src="/javascripts/jquerytagsinput.js" type="text/javascript"></script>
    <script src="/javascripts/ejs.min.js"></script>
    <script id="shopList" type="text/template">
      {{ if (shopLists != null && shopLists.length) { }}
		<table class="bordered-table" style="width: 500px;">

          {{ shopLists.forEach(function(shopList){ }}
			<tr>	
				<td>{{= shopList.name }}</td>
            	<td style="width: 160px; text-align: center;">
            	<a href="#" class="btn primary" data-loading-text="shopping!" onclick="goShopWithList(this, '{{= shopList._id }}', '{{= shopList.name }}');">Go shop</a>
		        <a href="#" class="btn" data-loading-text="deleting..." onclick="deleteList(this, '{{= shopList._id }}');">Delete</a>
            	</td>
            </li>
          {{ }) }}
	</table>
      {{ } }}
    </script>
    <script id="itemList" type="text/template">
      {{ if (itemLists != null && itemLists.length) { }}
		<table class="bordered-table" style="width: 500px;">

          {{ itemLists.forEach(function(itemList){ }}
			<tr>	
				<td style="{{ if(itemList.isBought) { }} background-color: #A9DBA9; {{ } }}">{{= itemList.name }}</td>
            	<td style="width: 160px; text-align: center;">
            	
            	<a href="#" class="btn primary {{ if(itemList.isBought) { }} disabled {{ } }}" data-loading-text="buing!" onclick="buyItem(this, '{{= listId }}', '{{= itemList._id }}');">Buy</a>
            	
		        <a href="#" class="btn" data-loading-text="deleting..." onclick="deleteItem(this, '{{= listId }}', '{{= itemList._id }}');">Delete</a>
            	</td>
            </li>
          {{ }) }}
	</table>
      {{ } }}
    </script>
	<script type="text/javascript">
			var ejs = require('ejs');
			ejs.open = '{{';
			ejs.close = '}}';	
		var shopListId;
		var initDone = false;
		function addShopList() {
			$('#addShopListButton').button('loading');
			now.addShopList($('#xlInput').val());
			$('#addShopListButton').button('reset');
			$('#xlInput').val("");
		}

		function addItemList(id) {
			$('#addShopListButton').button('loading');
			now.addItem(id, $("#xlInput").val());
			$('#addShopListButton').button('reset');
			$('#xlInput').val("");
		}

		
		now.displayPollData = function(list) {
			var shop = document.getElementById('shopList').innerHTML;
			var html = ejs.render(shop, { shopLists: list });
			$("#lists").html(html);
		}
		
		now.displayPollItemsData = function(list) {
			var items = document.getElementById('itemList').innerHTML;
			var html = ejs.render(items, { itemLists: list.items, listId: list._id });
			$("#lists").html(html);
			$("#coOwners").importTags('');
			$(list.coOwners).each(function(n, e) {
				$("#coOwners").addTag(e,{callback:false});			
			});

		}
		
		function deleteList(button, id) {
			$(button).button('loading');
			now.deleteShopList(id);
			$(button).button('reset');
		}
		
		function deleteItem(button, listId, id) {
			$(button).button('loading');
			now.deleteItem(listId, id);
			$(button).button('reset');
		}
		
		function buyItem(button, listId, id) {
			$(this).button('loading');
			now.buyItem(listId, id);
			$(this).button('reset');
		}
		
		function goShopWithList(button, id, name) {
			shopListId = id;
			$(button).button('loading');
			$("#shopListNameDiv").html("<h2>" + name + "</h2");
			$("#newElementLabel").html("New item:");
			$("#coOwnersDiv").show();
			$("#addShopListButton").unbind('click').click(function() {
				addItemList(id);
			});
			$("#xlInput").unbind('keypress').bind('keypress', function(e) {
				onEnterPress(e, function() {
						addItemList(id);
					});
				}
			);
			now.getShopList(id);
			$(button).button('reset');		
			document.url = document.url + "#" + id;
		}
		
		now.ready(function() {
			<% if (!everyauth.loggedIn) { %>

			<% } else { %>

				if(!initDone) {
					initDone = true;
			     	$("#addShopListButton").click(addShopList);
			     	$("#xlInput").keypress(function(e) {onEnterPress(e, addShopList);});
				    $("#coOwners").tagsInput({onAddTag:onAddTag,onRemoveTag:onRemoveTag, defaultText: "add user"});
				 }
  				now.getShopLists(); 
			<% } %>	
			});
			
		function onAddTag(tag) {
			if (!$('#coOwners').tagExist(tag)) {
				now.addCoOwner(shopListId, tag);
			}
		}
		function onRemoveTag(tag) {
			now.deleteCoOwner(shopListId, tag);
		}
		
		function onEnterPress(e, call) {
			if (e.keyCode == 13) {
				call();
				$(e.target).focus();
			}
		}
		
		window.addEventListener('load', function(e) {

  window.applicationCache.addEventListener('updateready', function(e) {
    if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
      // Browser downloaded a new app cache.
      // Swap it in and reload the page to get the new hotness.
      window.applicationCache.swapCache();

        window.location.reload();
      
    } else {
      // Manifest didn't changed. Nothing new to server.
    }
  }, false);

}, false);
	
	</script>
</head>
<body>
<div class="topbar" data-scrollspy="scrollspy" >
      <div class="topbar-inner">
        <div class="container">
          <a class="brand" href="/"><img src="/images/logo.png"/></a>
          <ul class="nav">
			<li><a href="/about">About</a></li>
<% if (!everyauth.loggedIn) { %>
			<li class="importantMenu"><a href="/auth/google">Login with Google</a></li>

<% } else { %>

			<li><a href="#"><%= everyauth.google.user.id %></a></li>
				<li><a href="/logout">logout</a></li>
			<% } %>
          </ul>
        </div>
      </div>
    </div>
	<div id="main" class="container">
		<div id="shopListNameDiv">
		</div>
    		<%- body %>
	</div>


<footer class="footer">
      <div class="container">
        <p class="pull-right"><a href="#">Back to top</a></p>
        <p>
         2012 &copy; FillCart4.me dev team.
        </p>
      </div>
    </footer>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-28373659-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
